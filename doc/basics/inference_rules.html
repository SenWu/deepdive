<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="DeepDive" />
    <link href='http://fonts.googleapis.com/css?family=Lato:300,400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="http://deepdive.stanford.edu/stylesheets/application.css" />
    <link rel="canonical" href="http://deepdive.stanford.edu">
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="http://deepdive.stanford.edu/javascripts/application.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepDive</title>
  </head>

  <body>
      <script type="text/javascript">
window.analytics||(window.analytics=[]),window.analytics.methods=["identify","track","trackLink","trackForm","trackClick","trackSubmit","page","pageview","ab","alias","ready","group","on","once","off"],window.analytics.factory=function(t){return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),window.analytics.push(a),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var method=window.analytics.methods[i];window.analytics[method]=window.analytics.factory(method)}window.analytics.load=function(t){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n)},window.analytics.SNIPPET_VERSION="2.0.8",
window.analytics.load("h6uwk48gwg");
window.analytics.page();
</script>
      <a href="https://github.com/hazyresearch/deepdive" target="_blank"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub"></a>

      <div id="header">
        <div class="container">
          <row>
            <div class="col-md-4 col-md-offset-1">
              <a href="http://deepdive.stanford.edu/" class="deepdive-logo">
              <img src="http://deepdive.stanford.edu/images/header_logo.png" style="width: 250px;"/>
              </a> 
            </div>
            <div class="col-md-6 col-md-offset-1">
              <ul class="list-unstyled list-inline" id="header-nav">
                <li><a href="http://deepdive.stanford.edu/index.html">Home</a></li>
                <li><a href="http://deepdive.stanford.edu/doc/basics/installation.html">Download</a></li>
                <li><a href="http://deepdive.stanford.edu/index.html#documentation">Documentation</a></li>
                <li><a href="https://mailman.stanford.edu/mailman/listinfo/deepdive-list" target="_blank">Mailing List</a></li>
              </ul>
              
            </div>
          </row>
        </div>
      </div>

      <section id="main">
        <div class="container">
          <row>
            <div class="col-md-10 col-md-offset-1">
              <h1>Writing inference rules</h1>

<p>Inference rules describe how to build the <a href="../general/inference.html">factor
graph</a>. Each rule
consists of three components:</p>

<ul>
<li><p>The <strong>input query</strong> specifies the variables to create. It is a SQL query that
usually combines relations created by the extractors. <strong>For each row</strong> in the
query result, the factor graph will have variables for a subset of the columns
in that row (those specified in the factor function, see below), all
connected by a factor. The result of the query <strong>must</strong> contain the reserved <code>id</code>
column for each of the variable involved in the factor function.</p></li>
<li><p>The <strong>factor function</strong> defines which variables (i.e., columns in the input
query result) to connect to each factor, and how they are related to each other.</p></li>
<li><p>The <strong>factor weight</strong> describes the confidence in the relationship expressed
by the factor. This is used during probabilistic inference. Weights can be
constants, or automatically learned based on training data. </p></li>
</ul>

<p>The following is an example of an inference rule:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">deepdive <span class="o">{</span>
  inference.factors: <span class="o">{</span>
    smokesFactor <span class="o">{</span>
      input_query : <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT people.id         AS &quot;</span>people.id<span class="s2">&quot;,</span>
<span class="s2">               people.smokes     AS &quot;</span>people.smokes<span class="s2">&quot;,</span>
<span class="s2">               people.has_cancer AS &quot;</span>people.has_cancer<span class="s2">&quot;,</span>
<span class="s2">               people.gender     AS &quot;</span>people.gender<span class="s2">&quot;</span>
<span class="s2">        FROM people</span>
<span class="s2">        &quot;&quot;&quot;</span>
      <span class="k">function</span>    : <span class="s2">&quot;Imply(people.smokes, people.has_cancer)&quot;</span>
      weight      : <span class="s2">&quot;?(people.gender)&quot;</span>
    <span class="o">}</span>

    <span class="c"># More rules...</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<h3>Factor input query</h3>

<p>The input query of a factor returns a set of tuples. Each tuple must contain all
the variables that a factor is using, plus additional columns that are used to
learn the weight of the factor. It usually takes the form of a join query
using feature relations produced by extractors, as in the following example:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">someFactor <span class="o">{</span>
  input_query: <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT p1.id     AS &quot;</span>people.p1.id<span class="s2">&quot;,     p2.id     AS &quot;</span>people.p2.id<span class="s2">&quot;,</span>
<span class="s2">           p1.smokes AS &quot;</span>people.p1.smokes<span class="s2">&quot;, p2.smokes AS &quot;</span>people.p2.smokes<span class="s2">&quot;,</span>
<span class="s2">           friends.person_id AS &quot;</span>friends.person_id<span class="s2">&quot;</span>
<span class="s2">    FROM friends</span>
<span class="s2">      INNER JOIN people AS p1 ON (friends.person_id = p1.id)</span>
<span class="s2">      INNER JOIN people AS p2 ON (friends.friend_id = p2.id)</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="c"># ...</span>
<span class="o">}</span>
</code></pre></div>
<p>There are a number of caveats when writing input queries for factors:</p>

<ul>
<li><p>The query result <strong>must</strong> contain all variable attributes that are used in your
factor function. For example, if you are using the <code>people.has_cancer</code>
variable in the factor function, then an attribute called <code>people.has_cancer</code>
must be part of the query result. </p></li>
<li><p>Always use <code>[relation_name].[attribute]</code> to refer to the variables in the
factor function, regardless whether or not you are using an alias in your input
query. For example, even if you write <code>SELECT p1.is_male from people p1</code>, the
variable would be called <code>people.is_male</code>.</p></li>
<li><p>The query result <strong>must</strong> contain the reserved column <code>id</code> for each variable.
DeepDive uses <code>id</code> column to assign unique variable ids. For example, if you
have <code>people.has_cancer</code> variable in your factor function, then <code>people.id</code>
must also be part of the query result. There are several <strong>requirements for
the <code>id</code> column</strong>:</p>

<ul>
<li>When creating a table containing variables, the column <code>id</code> must be
explicitly created, with the type of big integer, i.e. <code>id bigint</code>.</li>
<li>The value of <code>id</code> should <strong>always</strong> be <code>NULL</code> before the inference step.
DeepDive fills this column with variable IDs in the inference steps, so
any value in this column will be lost.</li>
<li>If you use Greenplum, the column <code>id</code> must not be the distribution key for
a table.</li>
<li>If you want an unique identifier of this table to refer to, you should use
columns other than <code>id</code>.</li>
<li>Generally, for any table in a DeepDive application, it is recommended
<strong>not</strong> to use the name <code>id</code> for any column other than this reserved
field. Meaningful column names such as <code>sentence_id</code>, <code>people_id</code> are
recommended.</li>
<li>The values in the columns used to learn the factor weight should not be <code>null</code>.</li>
</ul></li>
<li><p>When using self-joins, you must avoid naming collisions by defining an alias in
your query. For example, the following will <strong>not</strong> work:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">p1</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p1</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">p2</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p2</span><span class="p">.</span><span class="n">id</span> <span class="k">FROM</span> <span class="n">people</span> <span class="n">p1</span> <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">people</span> <span class="n">p2</span> <span class="k">ON</span> <span class="n">p1</span><span class="p">.</span><span class="n">manager_id</span> <span class="o">=</span> <span class="n">p2</span><span class="p">.</span><span class="n">id</span>
</code></pre></div>
<p>Instead, you must write something like the following:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">p1</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="ss">&quot;p1.name&quot;</span><span class="p">,</span> <span class="n">p1</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="ss">&quot;p1.id&quot;</span><span class="p">,</span> <span class="n">p2</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="ss">&quot;p2.name&quot;</span><span class="p">,</span> <span class="n">p2</span><span class="p">.</span><span class="n">id</span>
<span class="k">AS</span> <span class="ss">&quot;p2.id&quot;</span> <span class="k">FROM</span> <span class="n">people</span> <span class="n">p1</span> <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">people</span> <span class="n">p2</span> <span class="k">ON</span> <span class="n">p1</span><span class="p">.</span><span class="n">manager_id</span> <span class="o">=</span> <span class="n">p2</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</code></pre></div>
<p>Your factor function variables would be called <code>people.p1.name</code> and
<code>people.p2.name</code>.</p></li>
</ul>

<h3>Factor function</h3>

<p>The factor function defines which variables should be connected to the factor,
and how they are related. All variables used in a factor function must have been
previously defined in the <a href="schema.html">schema</a>.</p>

<p>DeepDive supports <a href="inference_rule_functions.html">several types of factor
functions</a>. One example of a factor function is
the <code>Imply</code> function, which expresses a first-order logic statement. For
example, <code>Imply(B, C, A)</code> means &quot;if B and C, then A&quot;.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">    <span class="c"># If people.smokes, then people.has_cancer</span>
    someFactor <span class="o">{</span>
      <span class="k">function</span>: <span class="s2">&quot;Imply(people.smokes, people.has_cancer)&quot;</span>
    <span class="o">}</span>

    <span class="c"># Evaluates to true, when people.has_cancer is true</span>
    someFactor <span class="o">{</span>
      <span class="k">function</span>: <span class="s2">&quot;Imply(people.has_cancer)&quot;</span>
    <span class="o">}</span>
</code></pre></div>
<h4>Using arrays in factor functions</h4>

<!-- TODO (Amir) The following is confusing. Add an example -->

<p>To use array of variables in factor function, in the input query, generate
corresponding variable ids in array form, and rename it as <code>relation.id</code>, where
<code>relation</code> is the table containing these variables, i.e., the naming convention
for array variables is same as single variables, whereas the only difference is
variable ids are in array form.</p>

<h3>Factor Weights</h3>

<p>Each factor is assigned a <em>weight</em>, which expresses the confidence in the
relationship it express. In the probabilistic inference steps, factors with
large weights have a greater impact on variables than factors with small
weights. Factor weights are real numbers, and are relative to each other. You
can assign factor weights manually, or you can let DeepDive learn weights
automatically. In order to learn weights automatically, you must have enough
<a href="../general/relation_extraction.html">training data</a> available. The weight can
also be a function of variables, in which case each factor will get a different
weight depending on the variable value.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Known weight (10 can be treated as positive infinite)</span>
someFactor.weight: 10

<span class="c"># Learn the weight, not depending on any variables. All factors created by this rule will have the same weight.</span>
someFactor.weight: ?

<span class="c"># Learn the weight. Each factor will get a different weight depending on the value of people.gender</span>
someFactor.weight: ?<span class="o">(</span>people.gender<span class="o">)</span>
</code></pre></div>
<h4>Re-use learned weights</h4>

<p>If the system already learned the weights for your factor graphs, you can tell
DeepDive to skip learning them again by setting <code>inference.skip_learning</code> in the
application configuration file. Refer to the <a href="configuration.html#skip_learning">Configuration
reference</a> for more details about this option.</p>

<h4>Custom weight table</h4>

<p>You can specify a table for the factor weights by setting
<code>inference.weight_table</code> along with <code>inference.skip_learning</code> (learning will be
skeep). This is useful to learn the weights once and use the model for later
inference tasks. Refer to the <a href="configuration.html#weight_table">Configuration
reference</a> for more details about this option
and the schema of the weight table.</p>

<!-- TODO (MR) All that follows must go somewhere else

### Evidence and Query variables

Evidence is training data that is used to automatically learn [factor
weights](inference_rules.html). DeepDive will treat variables with existing
values as evidence. In the above example, rows in the *people* table with a
`true` or `false` value in the *smokes* or *has_cancer* column will be treated
as evidence for that variable. Cells without a value (NULL) value will be
treated as query variables.

The inference results are stored in the database, in the table named `[variable
name]_inference`. DeepDive gives expectation for each variable, which is the
most probable value that the variable may take. Also, the learned weights are
stored in the table `dd_inference_result_weights`.
-->

            </div>
          </row>
        </div>
      </section>
    
      <footer id="footer">
        <div class="container">
          <row>
            <div class="col-md-10 col-md-offset-1">
              <p class="pull-left"> 
                Copyright, 2014 deepdive.stanford.edu
                ⋅
                <a href="mailto:contact.hazy@gmail.com">Questions? Email us</a>
              </p>
              <p class="pull-right"> 
                Visit DeepDive on <a href="https://github.com/hazyresearch/deepdive" target="_blank">Github</a> 
              </p>
            </div>
          </row>
        </div>
      </footer>

    
  
  </body>
</html>
